{# dashboard.html #}
{% extends "base.html" %}

{% block title %}Administration - CRM ADS 360{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">Administration Système</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Accueil</a></li>
                <li class="breadcrumb-item active">Administration</li>
            </ol>
        </nav>
    </div>
    <div>
        <button class="btn btn-primary" onclick="window.location.href='{{ url_for('admin.settings') }}'">
            <i class="fas fa-cog me-2"></i>Paramètres
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon primary"><i class="fas fa-users"></i></div>
            <div class="stat-value">{{ stats.users_count or 0 }}</div>
            <div class="stat-label">Utilisateurs actifs</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up me-1"></i>{{ stats.new_users_month or 0 }} ce mois
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon success"><i class="fas fa-building"></i></div>
            <div class="stat-value">{{ stats.entities_count or 0 }}</div>
            <div class="stat-label">Entités</div>
            <div class="stat-change">
                <span class="badge badge-info">{{ stats.partners_count or 0 }} partenaires</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon warning"><i class="fas fa-shield-alt"></i></div>
            <div class="stat-value">{{ stats.roles_count or 0 }}</div>
            <div class="stat-label">Rôles définis</div>
            <div class="stat-change">
                <span class="badge badge-warning">{{ stats.custom_roles or 0 }} personnalisés</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon info"><i class="fas fa-server"></i></div>
            <div class="stat-value">{{ stats.system_health or 0 }}%</div>
            <div class="stat-label">Santé système</div>
            <div class="stat-change positive">
                <i class="fas fa-check-circle me-1"></i>Opérationnel
            </div>
        </div>
    </div>
</div>

<!-- Admin Cards -->
<div class="row mb-4">
    {% set admin_cards = [
        {'title': 'Utilisateurs', 'url': 'admin.users', 'icon': 'users', 'color': 'primary', 'desc': 'Gérer les comptes utilisateurs'},
        {'title': 'Rôles & Permissions', 'url': 'admin.roles', 'icon': 'shield-alt', 'color': 'success', 'desc': 'Configurer les accès'},
        {'title': 'Entités', 'url': 'admin.entities', 'icon': 'building', 'color': 'warning', 'desc': 'Gérer les organisations'},
        {'title': "Logs d'audit", 'url': 'admin.audit_logs', 'icon': 'history', 'color': 'info', 'desc': "Historique des actions"}
    ] %}
    {% for card in admin_cards %}
    <div class="col-md-3">
        <div class="card admin-card" onclick="window.location.href='{{ url_for(card.url) }}'">
            <div class="card-body text-center">
                <div class="admin-icon mb-3">
                    <i class="fas fa-{{ card.icon }} fa-3x text-{{ card.color }}"></i>
                </div>
                <h5>{{ card.title }}</h5>
                <p class="text-muted small">{{ card.desc }}</p>
                <button class="btn btn-sm btn-{{ card.color }}">Accéder</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Charts and Activity -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header"><h5 class="mb-0">Activité système (7 derniers jours)</h5></div>
            <div class="card-body">
                <canvas id="activityChart" height="80"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header"><h5 class="mb-0">Actions récentes</h5></div>
            <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                {% for log in recent_logs or [] %}
                <div class="activity-item d-flex align-items-start mb-3">
                    <div class="activity-icon me-3">
                        <div class="avatar avatar-sm bg-{{ log.icon_color or 'primary' }}">
                            <i class="fas fa-{{ log.icon or 'info' }} text-white"></i>
                        </div>
                    </div>
                    <div class="activity-content flex-grow-1">
                        <p class="mb-1"><strong>{{ log.user_email or '' }}</strong> <span class="text-muted">{{ log.action or '' }}</span></p>
                        <small class="text-muted">{{ log.created_at or '' }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
const ctx = document.getElementById('activityChart')?.getContext('2d');
if(ctx){
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ activity_labels|default([])|tojson }},
            datasets: [
                {
                    label: 'Connexions',
                    data: {{ activity_logins|default([])|tojson }},
                    borderColor: '#0F7BFF',
                    backgroundColor: 'rgba(15, 123, 255, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Actions',
                    data: {{ activity_actions|default([])|tojson }},
                    borderColor: '#70C05B',
                    backgroundColor: 'rgba(112, 192, 91, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}
</script>
{% endblock %}
